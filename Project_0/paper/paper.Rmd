---
title: Factors affecting reliablity of state-space age-structured assessment models
author: 
  - Timothy J. Miller^1^, Britten, Brooks, Fay, Legault, Stock, et al.
date: ''
fontsize: 12pt
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    includes:
      in_header:
      - options.sty
      - journalshortcuts.tex
    keep_tex: yes
    number_sections: yes
  html_document:
    df_print: paged
  word_document: default
header-includes:
- \usepackage{xspace}
- \usepackage{bm}
- \usepackage{caption,graphics}
- \usepackage{graphicx}
- \usepackage{makecell}
- \renewcommand\figurename{Fig.}
- \captionsetup{labelsep=period, singlelinecheck=false}
- \newcommand{\changesize}[1]{\fontsize{#1pt}{#1pt}\selectfont}
- \renewcommand{\arraystretch}{1.5}
- \renewcommand\theadfont{}
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl
biblio-style: cjfas2.bst
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE, fig.align = "center")
knitr::opts_knit$set(root.dir = '../' )
library(knitr)
library(tidyverse)
library(pander)
library(kableExtra)
library(png)
library(forcats)
```

$^1$corresponding author: timothy.j.miller@noaa.gov, Northeast Fisheries Science Center, Woods Hole Laboratory, 166 Water Street, Woods Hole, MA 02543 USA\

\pagebreak

## Abstract {-}

### Keywords {-}

\pagebreak

# Introduction  

Application of state-space models in fisheries stock assessment and management has expanded dramatically within ICES, Canada and the Northeast US \citep{nielsenberg14,cadigan16,stockmiller21}.

Much is known about the reliability of state-space models that are linear or Gaussian \citep{aeberhardetal18}, but applications in fisheries management are nonlinear and typically include multiple types of observations with varying distributional assumptions. We know relatively little about the statistical reliability of such models. Also, there is a wide range of potential random effects structures in assessment models and we  know little about the ability of information criteria to distinguish among such alternative structures. 

But those studies focus primarily on Gaussian linear models.
review literature on reliability of hidden/latent process models. Primarily in other fields.

Here we conduct a simulation study with operating models varying by degree of observation error uncertainty, sources of process error (M, NAA, q, sel), and fishing history. The simulations from these operating models are fitted with estimating models that make alternative assumptions for sources of process error (M, NAA< q, sel), whether a stock-recruit model was estimated, and whether M is estimated. We evaluate whether AIC can correctly determine the correct source of process error and stock effects on recruitment. We also evaluate the degree of bias in the outputs of the assessment model that are important for management.

# Methods

Used the WHAM package  \citep[][commit 77bbd94]{stockmiller21} (Miller and Stock 2020). This packages has also been used to configure operating and estimating models for closed loop simulations evaluating index-based assessment methods \citep{legaultetalinpress} and is used for management of haddock, butterfish, plaice, bluefish in the Northeast US.

We completed a simulation study with a number of operating models that can be categorized based on where random effects are assumed: abundance at age, natural mortality, fleet selectivity, or index catchability. For each operating model assumptions about variance of process errors and observations are required and the values we used were based on a review of the range of estimates from recent applications of WHAM in management of stocks of haddock, butterfish, and American plaice in the NE US.

We simulated 100 data sets for each operating model.
For each simulated data from each operating model we fit a set of estimating models.

Y estimating models fit to each 

## Operating models

common to all:   
  ages = 1 to 10+, 
  M
  maturity

marginal standard deviations for random effects are defined in tables of operating models.



### Population

There are 10 age classes: ages 1 to 10+.

Spawning was assumed to occur 1/4 of the way through the year.

Natural mortality rate was assumed 0.2 when it was constant and the mean of the time series process for operating models with M random effects.
maturity a50 = 2.89, slope = 0.88
  
Weight at age was generated with a LVB growth
\[
L_a = L_{\infty}\left(1 - e^{-k(a - t_0)}\right)
\]
where $t_0 = 0$, $L_\infty = 85$, and $k = 0.3$, and a L-W relationship such that 
\[
W_a = \theta_1 L_a^{\theta_2}
\]
where $\theta_1 = e^{-12.1}$ and $\theta_2 = 3.2$.

We assumed a Beverton-Holt stock recruit function with constant pre-recruit mortality parameters for all operating models. All post-recruit productivity components are constant in the NAA and survey catchability process error operating models. Therefore steepness and unfished recruitment are also constant over the time period for those operating models (Miller and Brooks 2021). We specified unfished recruitment = $R_0 = e^{10}$ and $F_{\text{MSY}} = F_{40} = 0.348$ equated to a steepness of 0.69 and $\alpha=0.60$ and $\beta = 2.4 \times 10^{-5}$ for the
\[
N_{1,y} = \frac{\alpha \text{SSB}_{y-1}}{1 + \beta \text{SSB}_{y-1}} 
\]
Beverton-Holt parameterization.


The magnitude of the overfishing assumptions is based on average estimates of overfishing for NE groundfish stocks from Wiedenmann et al. (20XX). Legault et al. (2023) also used similar approaches to defining fishing mortality histories for operating models.

Currenlty, initial population is configured at the equilibrium distribution fishing at $F = 2.5\times F_{\text{MSY}}$.

Initial population was configured at the equilibrium distribution fishing at either $F = 2.5\times F_{\text{MSY}}$ or $F = F_{\text{MSY}}$ for the two alternative fishing histories. That is for a deterministic model, the age composition would not change over time when the fishing mortality was constant at the respective level. 


For operating models with time-varying random effects for M, steepness is not constant, but we used the same alpha and beta parameters as other operating models this equates to a steepness and R0 at the mean of the time series process for M. For operating models with time-varying random effects for fishery selectivity, Fmsy is also not constant however we use the same F history as other operating models which corresponds to Fmsy at the mean selectivity parameters.

### Fleets

We assumed a single fleet operating year round for catch observations with logistic selectivity for the fleet with $a_{50} = 5$ and slope = 1. This selectivity is was used to define $F_{\text{MSY}}$ for the Beverton-Holt stock recruitment parameters above. We assumed a logistic-normal distribution for the age-composition observations for the fleet.

### Fishing histories
All operating models assumed one of two different fishing histories. 
One : Fishing mortality is equal to Fmsy (0.348) for the whole 40 year period.
Two : Fishing mortality is 2.5 times Fmsy for the first 20 years then changes to Fmsy for the last 20 years.

### Indices
Two time series of surveys are assumed and observed in numbers rather than biomass for the entire 40 year period with one occurring in the spring (0.25 way through the year) and one in the fall (0.75 way through the year). Actually we have it currently configured that both occur 0.5 way through the year. Catchability of both surveys are assumed to be 0.1.  We assumed logistic selectivity for both indices with $a_{50} = 5$ and slope = 1. We assumed a logistic-normal distribution for the age-composition observations.


### Observation Uncertainty 

Standard deviation for log-aggregate catch was 0.1. There were two levels of observation error variance for indices and age composition for both indices and fleet catch. A low uncertainty specification assumed standard deviation of both series of log-aggregate index observations was 0.1 and the standard deviation of the logistic-normal for age composition observations was 0.3 In the high uncertainty specification the standard deviation for log-aggregate indices was 0.4 and that for the age composition observations was 1.5. For all estimating models, standard deviation for log-aggregate observations was assumed known whereas that for the logistic-normal age composition observations was estimated.


### Operating models with random effects on numbers at age

24 operating models, 16 Sel re operating models and 16 q re operating models.
Table of process error assumptions

### Operating models with random effects on natural mortality

16 operating models
Table of process error assumptions

NOTE: inv_trans_rho function in set_M.R is mis-defined. Will affect correlation parameters assigned in operating models?

Steepness and BRPs are not constant when M is time-varying (Miller and Brooks 2021). We uses the a/b parameters for the B-H defined for Fmsy = F40 at the mean M = 0.2 as defined above. 

### Operating models with random effects on fleet selectivity

16 operating models
Table of process error assumptions

BRPs are not constant when fleet selectivity is time-varying. We uses the a/b parameters for the B-H defined for Fmsy = F40 at the mean of the time series model for selectivity which is the same as the constant selectivity defined above. 

### Operating models with random effects on index catchability

16 operating models
Table of process error assumptions

## Estimating models

32 estimating models
Table of estimating models

1-20 fit to each NAA RE operating model
5-24 fit to each M RE operating model
5-20,25-28 to each sel RE operating model
5-20, 29-32 to each q RE operating model

SR estimation or not

Make plot of S-R curve, Fmsy = F40
Initial values for BH parameters are the true values.
Initial values for mean R model = true R0.

M estimation or not

NAA_re
Random effects on Recruitment only or random effects on recruitment and transitions among older numbers at age.

M_re
Random effects on Recruitment only, M constant across age .

sel_re
Random effects on Recruitment only, fleet logistic selectivity RE model?

q_re
Random effects on Recruitment only, one survey catchability RE model?

Simulations were all carried out on the University of Massachusetts Green High-Performance Computing Cluster. Code for completing the simulations and summarization of results can be found at github.com/timjmiller/SSRTWG/Project_0. We used the wham package version 1.X.X (commit 77bbd94).

# Results

Do each of these by type of operating model (Naa, M, sel, q)
Convergence performance

AIC performance

SR estimation? M estimation?

Bias, Mean Square error

  Certain basic parameters (stock-recruit pars, M, variance parameters)
  SSB, F, R

\clearpage 
## Numbers at age operating models

### Estimating models include alternative random effects options: NAA, M, sel, q
\clearpage 

\begin{landscape}
\begin{table}
\caption{Distinguishing characteristics of the operating models with random effects on survival. Standard deviations (SD) are for log-normal distributed indices and logistic normal distributed age composition observations (fleet and indices). Fishing mortality changes after year 20 (of 40) for fishing histories where fishing mortality is not constant.}
{\footnotesize \input{naa_om_tab}}
\end{table}

\begin{table}
\caption{Distinguishing characteristics of the operating models with random effects on natural mortality. Standard deviations (SD) are for log-normal distributed indices and logistic normal distributed age composition observations (fleet and indices). Fishing mortality changes after year 20 (of 40) for fishing histories where fishing mortality is not constant. For AR1 process errors, $\sigma$ is defined for the marginal distribution of the processes.}
{\input{M_om_tab}}
\end{table}

\begin{table}
\caption{Distinguishing characteristics of the operating models with random effects on selectivity. Standard deviations (SD) are for log-normal distributed indices and logistic normal distributed age composition observations (fleet and indices). Fishing mortality changes after year 20 (of 40) for fishing histories where fishing mortality is not constant. For AR1 process errors, $\sigma$ is defined for the marginal distribution of the processes.}
{\input{Sel_om_tab}}
\end{table}

\begin{table}
\caption{Distinguishing characteristics of the operating models with random effects on catchability. Standard deviations (SD) are for log-normal distributed indices and logistic normal distributed age composition observations (fleet and indices). Fishing mortality changes after year 20 (of 40) for fishing histories where fishing mortality is not constant. For AR1 process errors, $\sigma$ is defined for the marginal distribution of the processes.}
{\input{q_om_tab}}
\end{table}
\end{landscape}

\begin{table}
\caption{Distinguishing characteristics of the estimating models.}
{\scriptsize \input{em_tab}}
\end{table}

\begin{table}
\caption{NAA operating models, estimating models all assume a B-H stock recruit relationship and M is fixed at the true value.}
{\input{naa_om_em_SR_MF_aic_table}}
\end{table}

\begin{table}
\caption{NAA operating models, estimating models all assume a B-H stock recruit relationship and M is estimated.}
{\input{naa_om_em_SR_ME_aic_table}}
\end{table}

\begin{table}
\caption{NAA operating models, estimating models all estimate a mean recruitment and M is fixed at the true value.}
{\input{naa_om_em_R_MF_aic_table}}
\end{table}

\begin{table}
\caption{NAA operating models, estimating models all estimate a mean recruitment and M estimated.}
{\input{naa_om_em_R_MF_aic_table}}
\end{table}
\clearpage 

\begin{landscape}
\begin{figure}
\caption{Median relative bias of for SSB for estimating models that estimate mean recruitment and M is fixed at the true value.}\label{naa_om_em_R_MF_relbias_ssb}
\begin{center}
\includegraphics[width = \textwidth]{naa_om_R_MF_relbias_ssb.png}
\end{center}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}
\caption{Median relative bias of for SSB for estimating models that estimate mean recruitment and M is estimated.}\label{naa_om_em_R_ME_relbias_ssb}
\begin{center}
\includegraphics[width = \textwidth]{naa_om_R_ME_relbias_ssb.png}
\end{center}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}
\caption{Median relative bias of for SSB for estimating models that estimates a BH stock-recruitment function and M is fixed at the true value.}\label{naa_om_em_SR_MF_relbias_ssb}
\begin{center}
\includegraphics[width = \textwidth]{naa_om_SR_MF_relbias_ssb.png}
\end{center}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}
\caption{Median relative bias of for SSB for estimating models that estimates a BH stock-recruitment function and M is estimated.}\label{naa_om_em_SR_ME_relbias_ssb}
\begin{center}
\includegraphics[width = \textwidth]{naa_om_SR_ME_relbias_ssb.png}
\end{center}
\end{figure}
\end{landscape}



### Estimating models include NAA random effects and estimation assumes mean R or BH SR
\clearpage

\begin{table}
\caption{Operating models and estimation models all assume RE on recruitment only, estimating models assume mean recruitment or a B-H stock recruit relationship and M is fixed at the true value.}
{\input{rec_om_em_R_SR_MF_aic_table}}
\end{table}

\begin{table}
\caption{Operating models and estimation models all assume RE on recruitment only, estimating models assume mean recruitment or a B-H stock recruit relationship and M is estimated.}
{\input{rec_om_em_R_SR_ME_aic_table}}
\end{table}

\begin{table}
\caption{Operating models and estimation models all assume RE on all abundances at age, estimating models assume mean recruitment or a B-H stock recruit relationship and M is fixed at the true value.}
{\input{naa_om_em_R_SR_MF_aic_table}}
\end{table}

\begin{table}
\caption{Operating models and estimation models all assume RE on all abundances at age, estimating models assume mean recruitment or a B-H stock recruit relationship and M is estimated.}
{\input{naa_om_em_R_SR_ME_aic_table}}
\end{table}
\clearpage 

\begin{figure}
\caption{Predicted probability of AIC being better for BH model.}\label{glm_res_NAA_re}
\begin{center}
\includegraphics[width = \textwidth]{pred_SR_best_NAA_oms.png}
\end{center}
\end{figure}

## M operating models

### Estimating models include NAA random effects and estimation assumes mean R or BH SR

\begin{table}
\caption{M random effects operating models.}
{\input{M_om_em_R_BH_aic_table}}
\end{table}
\clearpage 


# Discussion

The estimating models assumed variances of aggregate catch and index observations was known. This approximation may be appropriate for indices
where we have a reliable estimate of uncertainty based on the survey design (), but there may be better approaches for the aggregate
catch such as an informed prior on the standard errors with realistic bounds.


# Acknowledgements {-}

This work was funded by NOAA Fisheries Northeast Fisheries Science Center. 

<!--
# CRediT authorship contribution statement {-}

**Timothy J. Miller:** Conceptualization, Methodology, Writing - original draft, Formal analysis, Visualization.
 -->
 
\pagebreak

\bibliography{paper}
<!-- \bibliography{project-0-paper}
\bibliographystyle{/home/tmiller2/work/bibliographies/cjfas2}  -->

<div id="refs"></div>

\pagebreak
<!-- 
\begin{figure}
\caption{Diagram of twin-trawl gear configuration. One of the two nets is rigged with a rockhopper sweep (8) and the other is rigged with a chain sweep (7) and for both a restrictor rope (5) is used to obtain consistent net spread. The other importand components are the side wires (1), middle wire (2), doors (3), the clump weight (4), and the acoustic mensuration system (6).  The side where the rockhopper and chainsweep gears gears were deployed varied throughout the experimental tows of each.}\label{twin_trawl_diagram}
\begin{center}
\includegraphics[width = \textwidth]{twin_trawl_diagram.pdf}
\end{center}
\end{figure}

\begin{figure}
\caption{The \textsl{F/V Karen Elizabeth} twin-trawl vessel rigged with rockhopper sweep gear on the right and chain sweep gear on the left.}\label{twin_trawl_photo}
\begin{center}
\includegraphics[width = \textwidth]{twin_trawl_photo_small.png}
\end{center}
\end{figure} -->


<!--
\begin{figure}
\caption{Diagram of the standard Northeast Fisheries Science Center rockhopper sweep center and wing sections.}\label{rockhopper_schematic}
\begin{center}
\includegraphics[width = 0.7\textwidth]{rockhopper_schematic_1.pdf}
\includegraphics[width = 0.7\textwidth]{rockhopper_schematic_2.pdf}
\end{center}
\end{figure}

\begin{figure}
\caption{Diagram of the chain sweep designed maximize bottom contact and flatfish capture.}\label{chainsweep_schematic}
\begin{center}
\includegraphics[width = \textwidth]{chainsweep_schematic.pdf}
\end{center}
\end{figure}
\clearpage
  -->
<!-- \begin{landscape}
\begin{figure}
\caption{Annual locations of stations where the F/V Karen Elizabeth conducted twin-trawl sets with the standard bottom trawl gear and the gear with a chain sweep instead of the rockhopper sweep.}\label{tow_locations}
\begin{center}
\includegraphics[width = \textwidth]{TwinTrawlLocationsAllYears.jpg}
\end{center}
\end{figure}
\end{landscape}

\clearpage 

\begin{figure}
\caption{Relative efficiency  of gears using chain and rockhopper sweeps from the best performing model for each species (Table \ref{best_model_compare}). Blue and red denote results for day and night data, respectively, and thick and thin lines represent overall and paired-tow specific estimates of relative catch efficiency, respectively. There was no diel effect in the best model for American plaice. Points represent empirical estimates of relative efficiency for paired observation by length and paired tow. Polygons and dashed lines represent hessian-based and bootstrap-based 95\% confidence intervals, respectively.}\label{sp_rho_plot}
\begin{center}
\includegraphics[height = 0.8\textheight]{sp_rho_plot.pdf}
\end{center}
\end{figure}

\clearpage 

\begin{figure}
\caption{Annual spring (blue) and fall (red) biomass estimates for each managed stock assuming 100\% efficiency for chain sweep gear with shaded polygons representing bootstrap-based 95\% confidence intervals. Relative catch efficiency at size estimates and bootstraps are from the best performing model for each species (Table \ref{best_model_compare}).}\label{stock_biomass_plot}
\begin{center}
\includegraphics[height = 0.8\textheight]{stock_biomass_plot.pdf}
\end{center}
\end{figure}

\clearpage

\begin{figure}
\caption{Implied catch efficiency of annual spring (blue) and fall (red) bottom trawl survey biomass estimates for each managed stock assuming 100\% efficiency for chain sweep gear with shaded polygons representing bootstrap-based 95\% confidence intervals. Relative catch efficiency at size estimates and bootstraps are from the best performing model for each species (Table \ref{best_model_compare}).}\label{stock_biomass_efficiency_plot}
\begin{center}
\includegraphics[height = 0.8\textheight]{stock_biomass_efficiency_plot.pdf}
\end{center}
\end{figure} -->

\clearpage




<!-- \begin{table}
\caption{Managed stocks associated with the species for which relative catch efficiency was estimated.}\label{stock_definition_table}
{\input{stock_definition_table}}
\end{table}

\begin{landscape}
\begin{table}
\caption{Description of relative catch efficiency ($\rho$) and beta-binomial dispersion ($\phi$) parameterizations for binomial and beta-binomial models and number of marginal likelihood parameters ($n_p$) for the 13 base models from \citet{miller13} and fit to paired chain sweep and rockhoppersweep tow data for each species.}\label{base_model_description}
{\input{base_model_description}}
\end{table}
\end{landscape}

\begin{landscape}
\begin{table}
\caption{Number of paired tows where fish were captured and the number of fish captured and measured for lengths for each species in total and by day or night.}\label{data_table}
{\changesize{10}\input{data_table}}
\end{table}
\end{landscape}

\begin{landscape}
\begin{table}\caption{Difference in AIC for each of the 13 models described in Table \ref{base_model_description} from the best model ($\bf 0$) by species.}\label{base_model_compare}
{\input{base_model_compare}}
\end{table}
\end{landscape}

\begin{landscape}
\begin{table}\caption{Best performing models from Table \ref{base_model_compare} and extended models that include diel effects on relative catch efficiency for each species with the number of parameters for each model ($n_p$) and the differences in AIC ($\Delta$AIC) from the best of the three models ($\bf 0$) by species.}\label{best_model_compare}
{\changesize{7}\input{best_model_compare}}
\end{table}
\end{landscape}

\begin{table}
\caption{Average of annual (2009-2019) ratios of coefficients of variation for calibrated and uncalibrated biomass indices for each stock by seasonal survey. Coefficients of variation are based on bootstrap resampling of paired tow observations, survey station data and associated length and weight observations. Annual indices for fall 2017 were not available for summer flounder, SNE-MA windowpane, and SNE-MA yellowtail flounder.}\label{stock_cv_ratios}
{\input{stock_cv_ratios}}
\end{table}

\begin{table}
\caption{Average correlation of annual (2009-2019) calibrated biomass indices for each stock by seasonal survey. Annual indices for fall 2017 were not available for SNE-MA windowpane and SNE-MA yellowtail flounder.}\label{stock_mean_cor}
{\input{stock_mean_cor}}
\end{table} -->
