# check out MSY

library(here)
library(tidyverse)
library(wham)



####
om_inputs <- readRDS(file.path(here::here(),"Ecov_study", "recruitment_functions", "inputs", "om_inputs.RDS"))
em_inputs <- readRDS(file.path(here::here(),"Ecov_study", "recruitment_functions", "inputs", "em_inputs.RDS"))
df.ems    <- readRDS(file.path(here::here(),"Ecov_study", "recruitment_functions", "inputs", "df.ems.RDS"))
df.oms    <- readRDS(file.path(here::here(),"Ecov_study", "recruitment_functions", "inputs", "df.oms.RDS"))
seeds <- readRDS(file.path(here::here(), "Ecov_study", "recruitment_functions", "inputs","seeds.RDS"))





#===============================================================================================
## easier models to explore (49, 113, 177, 241)             ====================================
# Ecov_obs_sig	Ecov_re_sig	obs_error	R_sig	Fhist	NAA_cor	Ecov_re_cor	Ecov_effect
# 0.1	            0.1	       L      	0.1 	H-MSY	0.2	    0.8	         1
#===================================================================================


##====================================================================================
#========   do.fit = FALSE     ======================================
###  om 49  ==========================================================================
# Ecov_how = 0, BH a,b are NOT affected
iterj=1
omi=  49      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 
y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )


om.49     <- fit_wham(om_inputs[[omi]], do.fit = FALSE, MakeADFun.silent = TRUE)
set.seed(seeds[[omi]][iterj])
sim_data  <- om.49$simulate(complete=TRUE)
truth     <- sim_data


om.49$rep$log_FMSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
om.49$fn()
om.49$report()$log_FMSY
# still NaN

om.49$rep$log_SR_a
# [1] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [8] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [15] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [22] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [29] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [36] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
om.49$rep$log_SR_b
# [1] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [9] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [17] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [25] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [33] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567

truth$log_FMSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
truth$log_SR_a
# [1] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [8] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [15] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [22] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [29] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [36] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
truth$log_SR_b
# [1] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [9] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [17] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [25] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [33] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
truth$log_SSB_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [19] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [37] NaN NaN NaN NaN
truth$log_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# truth$log_R_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [19] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [37] NaN NaN NaN NaN

##====================================================================================
#========   do.fit = FALSE     ======================================
###  om 113  ==========================================================================
# Ecov_how = 1, only BH a is affected
iterj=1
omi=  113      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 
y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )


om.113     <- fit_wham(om_inputs[[omi]], do.fit = FALSE, MakeADFun.silent = TRUE)
set.seed(seeds[[omi]][iterj])
sim_data  <- om.113$simulate(complete=TRUE)
truth     <- sim_data


om.113$rep$log_FMSY
# [1] -337.596612   -2.976233   -1.288128   -1.631625  -10.271300  -22.806324
# [7]  -24.853151   -2.299369   -1.195897  -29.390520   -3.154589         NaN
# [13]   -1.148362   -1.517247  -87.871273   -2.014903  -37.115564   -1.814311
# [19]   -1.334220   -1.557163  -20.363991         NaN  -10.981400         NaN
# [25]  -22.581689  -10.683270   -1.742167   -1.718971  -20.488527   -1.268512
# [31]         NaN  -21.548484  -21.226313         NaN  -63.834022  -22.246797
# [37]  -33.518255 -320.745214  -28.278736         NaN

 # ==== is it large Ecov devs creating NaN?? ====
# doesn't appear so... seems more like all the positive Ecov_x, and very negative Ecov_x have worst MSY soln 
rbind(om.113$rep$log_FMSY, t(om.113$rep$Ecov_x ) )
#          [,1]      [,2]      [,3]       [,4]       [,5]       [,6]
# [1,] -337.5966116 -2.976233 -1.288128 -1.6316248 -10.271300 -22.806324
# [2,]    0.3354919 -1.764859 -0.381452 -0.8223168  -2.425331   1.011291
#          [,7]      [,8]       [,9]       [,10]     [,11]     [,12]
# [1,] -24.8531510 -2.299369 -1.1958970 -29.3905198 -3.154589       NaN
# [2,]   0.8684461 -1.408797 -0.2394615   0.6975572 -1.830392 0.1566095
#          [,13]      [,14]       [,15]     [,16]       [,17]     [,18]
# [1,] -1.1483625 -1.5172475 -87.8712733 -2.014903 -37.1155643 -1.814311
# [2,] -0.1614331 -0.6888339   0.3948246 -1.194013   0.5671306 -1.012757
#          [,19]     [,20]      [,21]     [,22]      [,23]      [,24]
# [1,] -1.3342196 -1.557163 -20.363991       NaN -10.981400        NaN
# [2,] -0.4481337 -0.736772   1.334581 0.1500403  -2.802674 0.08853555
#       [,25]     [,26]      [,27]      [,28]      [,29]      [,30]
# [1,] -22.581689 -10.68327 -1.7421671 -1.7189711 -20.488527 -1.2685120
# [2,]   1.031813  -2.58550 -0.9406636 -0.9166431   1.310384 -0.3522413
#         [,31]      [,32]      [,33]     [,34]       [,35]      [,36]
# [1,]          NaN -21.548484 -21.226313       NaN -63.8340221 -22.246797
# [2,] -0.003557048   1.145348   1.189013 0.1823936   0.4321887   1.064876
#            [,37]        [,38]       [,39]     [,40]
# [1,] -33.5182551 -320.7452145 -28.2787364       NaN
# [2,]   0.6144916    0.3364522   0.7286584 0.2654806
rbind(om.113$rep$log_FMSY[order(om.113$rep$Ecov_x)], t(om.113$rep$Ecov_x [order(om.113$rep$Ecov_x)]) )
## what scale is Ecov_x on (transformed or not?)

om.113$fn()
om.113$report()$log_FMSY
# [1] -1.355083 -2.014456 -2.255895 -2.466683 -2.648746 -2.749291 -2.711935 -2.544552
# [9] -2.325278 -2.126919 -1.987519 -1.895684 -1.834643 -1.788734 -1.744457 -1.692749
# [17] -1.628177 -1.551025 -1.468613 -1.391267 -1.341450 -1.333266 -1.331564 -1.331822
# [25] -1.333426 -1.335310 -1.335710 -1.333431 -1.329393 -1.328297 -1.339627 -1.372102
# [33] -1.381051 -1.373710 -1.345984 -1.296538 -1.231766 -1.164654  6.342056  9.829294

om.113$report()$log_MSY
# [1] 9.307166 7.912406 7.424752 7.002672 6.639618 6.439466 6.513807 6.847267
# [9] 7.285543 7.684519 7.967228 8.154962 8.280574 8.375556 8.467632 8.575811
# [17] 8.712025 8.876681 9.055302 9.226065 9.337946 9.356487 9.360347 9.359762
# [25] 9.356124 9.351852 9.350945 9.356111 9.365275 9.367766 9.342072 9.268917
# [33] 9.248878 9.265312 9.327696 9.440283 9.590685 9.750618      NaN      NaN
om.113$report()$log_SSB_MSY
# [1] 11.117636 10.281146 10.009553  9.780089  9.585946  9.479962  9.519248
# [8]  9.696661  9.933366 10.153244 10.312200 10.419457 10.492069 10.547459
# [15] 10.601574 10.665709 10.747369 10.847516 10.958069 11.065762 11.137450
# [22] 11.149420 11.151915 11.151537 11.149185 11.146425 11.145839 11.149177
# [29] 11.155102 11.156714 11.140112 11.093111 11.080305 11.090805 11.130844
# [36] 11.203844 11.302908 11.410278       NaN       NaN
om.113$rep$log_SR_a
# [1] -0.18274555 -2.28309634 -0.89968946 -1.34055421 -2.94356851  0.49305378
# [7]  0.35020866 -1.92703455 -0.75769891  0.17931979 -2.34862900 -0.36162789
# [13] -0.67967054 -1.20707131 -0.12341288 -1.71225028  0.04889316 -1.53099472
# [19] -0.96637110 -1.25500940  0.81634355 -0.36819717 -3.32091153 -0.42970188
# [25]  0.51357549 -3.10373772 -1.45890103 -1.43488057  0.79214627 -0.87047874
# [31] -0.52179448  0.62711015  0.67077558 -0.33584380 -0.08604875  0.54663892
# [37]  0.09625416 -0.18178527  0.21042093 -0.25275688
om.113$rep$log_SR_b
# [1] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [9] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [17] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [25] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [33] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567

truth$log_FMSY
# [1] -1.159092 -1.146788  9.245344       NaN       NaN       NaN       NaN       NaN
# [9]       NaN       NaN       NaN       NaN       NaN       NaN       NaN -1.149125
# [17] -1.149718  3.586836  1.257911  9.631784  6.677094       NaN  7.946231  9.532357
# [25]       NaN       NaN  6.863106 -1.132213  7.960943 -1.141428 -1.209142 -1.197877
# [33]  7.755886       NaN       NaN  9.745110       NaN       NaN       NaN       NaN
truth$log_SR_a
# [1] -0.6975285 -0.6769343 -0.5626611 -0.4771062 -0.4352334 -0.3226436 -0.2743855
# [8] -0.4131188 -0.3552913 -0.2869883 -0.3019244 -0.3633016 -0.3288842 -0.3040625
# [15] -0.5159110 -0.6809069 -0.6818567 -0.6286659 -0.6442160 -0.5548191 -0.6072806
# [22] -0.4083482 -0.5878256 -0.5568354 -0.5096082 -0.4586611 -0.6048336 -0.6644559
# [29] -0.5875636 -0.6680084 -0.7788403 -0.7608767 -0.5911466 -0.5127609 -0.3946120
# [36] -0.5525257 -0.2528974 -0.3484076 -0.3362029 -0.4731461
truth$log_SR_b
# [1] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [9] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [17] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [25] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
# [33] -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567 -10.63567
truth$log_R_MSY
# [1] 9.561976 9.588905      NaN      NaN      NaN      NaN      NaN      NaN
# [9]      NaN      NaN      NaN      NaN      NaN      NaN      NaN 9.583713
# [17] 9.582479      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [25]      NaN      NaN      NaN 9.603457      NaN 9.600527 9.454594 9.478466
# [33]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
truth$log_SSB_MSY
# [1] 11.41942 11.43976      NaN      NaN      NaN      NaN      NaN      NaN
# [9]      NaN      NaN      NaN      NaN      NaN      NaN      NaN 11.43582
# [17] 11.43491      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [25]      NaN      NaN      NaN 11.44649      NaN 11.44851 11.33853 11.35648
# [33]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
truth$log_MSY
# [1] 9.764083 9.793987      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [10]      NaN      NaN      NaN      NaN      NaN      NaN 9.788233 9.786857      NaN
# [19]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [28] 9.812000      NaN 9.806890 9.644096 9.670875      NaN      NaN      NaN      NaN
# [37]      NaN      NaN      NaN      NaN


##====================================================================================
#========   do.fit = FALSE     ======================================
###  om 177  ==========================================================================
# Ecov_how = 2, only BH b is affected
iterj=1
omi=  177      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 
y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )


om.177     <- fit_wham(om_inputs[[omi]], do.fit = FALSE, MakeADFun.silent = TRUE)
set.seed(seeds[[omi]][iterj])
sim_data  <- om.177$simulate(complete=TRUE)
truth     <- sim_data


om.177$rep$log_FMSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
om.177$fn()
om.177$report()$log_FMSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN

om.177$rep$log_SR_a
# [1] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [8] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [15] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [22] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [29] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [36] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
om.177$rep$log_SR_b
# [1]  -9.359732 -12.511875 -10.657246  -9.983971  -9.510286 -10.409065 -11.552279
# [8] -11.656200 -11.028456 -11.760080  -8.667244 -12.138319 -10.636213 -12.604562
# [15] -11.061900 -11.612209 -11.843527 -10.127669 -10.849555 -11.334195 -12.461337
# [22] -11.041630 -13.076274  -9.836957 -10.074135 -10.550631 -10.874824  -8.836821
# [29] -11.297912 -10.471301 -11.163311 -10.905285  -9.820471 -11.480822  -9.752999
# [36] -10.800625 -10.548470 -11.234661 -10.012513 -10.839270
truth$log_FMSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
truth$log_SR_a
# [1] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [8] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [15] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [22] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [29] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
# [36] -0.5182374 -0.5182374 -0.5182374 -0.5182374 -0.5182374
truth$log_SR_b
# [1] -10.56221 -10.37775 -10.23619 -10.32068 -10.30899 -10.39924 -10.30620 -10.34187
# [9] -10.43497 -10.50823 -10.64357 -10.62596 -10.71866 -10.95352 -10.75679 -10.73979
# [17] -10.78624 -10.56444 -10.58856 -10.71717 -10.85270 -10.86509 -10.90789 -10.87361
# [25] -10.67051 -10.71745 -10.51733 -10.54647 -10.57835 -10.56874 -10.64778 -10.43115
# [33] -10.49750 -10.53807 -10.58406 -10.54819 -10.44584 -10.52822 -10.56356 -10.58284
truth$log_R_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [19] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [37] NaN NaN NaN NaN
truth$log_SSB_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [19] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [37] NaN NaN NaN NaN
truth$log_MSY
# [1] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN
# [21] NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN NaN


##====================================================================================
#========   do.fit = FALSE     ======================================
###  om 241  ==========================================================================
# Ecov_how = 4, so both a,b are affected
iterj=1
omi= 241      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 
y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )


om.241     <- fit_wham(om_inputs[[omi]], do.fit = FALSE, MakeADFun.silent = TRUE)
set.seed(seeds[[omi]][iterj])
sim_data  <- om.241$simulate(complete=TRUE)
truth     <- sim_data


om.241$rep$log_FMSY
# [1]    6.475118  -19.630884   -1.553439  -19.870835  -39.094196   -1.244710
# [7]  -10.936616   -2.132005  -20.307595   -1.189833 -104.085277   -1.202409
# [13]  -21.324533  -26.719967         NaN  -23.056860   -1.632897   -1.390964
# [19]  -78.078130         NaN  -48.717802   -1.184596  -22.139437   -1.221178
# [25]   -1.287857  -20.486629  -20.392292    2.950987  -20.065056   -2.502619
# [31]   -1.739152  -20.471535   -1.577734         NaN  -60.893624   10.198889
# [37]   -1.567094  -17.981442   -1.149682  -20.025866
om.241$rep$log_R_MSY
# [1]       NaN 10.092611  9.523188 10.090957 10.051171  9.696386       NaN
# [8]  9.150717 10.088172  9.725310 10.038715  9.718731 10.082626 10.065422
# [15]       NaN 10.075385  9.475726  9.616557 10.040791       NaN 10.046599
# [22]  9.728041 10.078932  9.708858  9.673251 10.087106 10.087663       NaN
# [29] 10.089684  8.880427  9.410411 10.087195  9.508801       NaN 10.043356
# [36]       NaN  9.515115 10.107193  9.746117 10.089936
om.241$fn()
om.241$report()$log_FMSY
# [1] -1.328779 -1.908249 -2.162934 -2.402121 -2.622500 -2.754700 -2.724322 -2.550863
# [9] -2.328409 -2.130427 -1.991931 -1.900238 -1.838544 -1.791760 -1.746827 -1.694722
# [17] -1.629861 -1.552450 -1.469790 -1.392206 -1.342199 -1.333906 -1.332112 -1.332295
# [25] -1.333835 -1.335661 -1.336010 -1.333688 -1.329613 -1.328484 -1.339778 -1.372208
# [33] -1.381131 -1.373769 -1.346022 -1.296554 -1.231763 -1.164639  6.344202  9.829926
om.241$report()$log_R_MSY
# [1] 9.650987 9.302119 9.129076 8.956036 8.788095 8.683691 8.707914 8.843546
# [9] 9.010418 9.151817 9.246568 9.307370 9.347404 9.377291 9.405611 9.437979
# [17] 9.477561 9.523771 9.571875 9.615862 9.643618 9.648176 9.649160 9.649059
# [25] 9.648215 9.647212 9.647020 9.648295 9.650530 9.651149 9.644949 9.627018
# [33] 9.622049 9.626150 9.641512 9.668545 9.703261 9.738401      NaN      NaN
om.241$rep$log_SR_a
# [1] -0.60978834  0.99002236 -1.25060064  0.92634360  0.02879862 -0.83433689
# [7] -3.27907193 -1.80623275  0.82772771 -0.74793096 -0.13729714 -0.76812658
# [13]  0.65695358  0.26389767 -0.34890056  0.47156486 -1.34197306 -1.04492182
# [19] -0.11159925 -0.25966510 -0.03565827 -0.73945016  0.55792795 -0.79782436
# [25] -0.89928832  0.79250582  0.81073288 -0.63317229  0.88003530 -2.05450681
# [31] -1.45580192  0.79537420 -1.27913750 -0.35169314 -0.07882096 -0.54343684
# [37] -1.26670643  1.86796110 -0.68179620  0.88904030
om.241$rep$log_SR_b
# [1] -10.727225  -9.127414 -11.368037  -9.191093 -10.088638 -10.951773 -13.396508
# [8] -11.923669  -9.289709 -10.865367 -10.254734 -10.885563  -9.460483  -9.853539
# [15] -10.466337  -9.645872 -11.459410 -11.162358 -10.229036 -10.377102 -10.153095
# [22] -10.856887  -9.559509 -10.915261 -11.016725  -9.324931  -9.306704 -10.750609
# [29]  -9.237401 -12.171943 -11.573238  -9.322062 -11.396574 -10.469130 -10.196257
# [36] -10.660873 -11.384143  -8.249475 -10.799233  -9.228396
truth$log_FMSY
# [1] -1.1552622  8.8370273 -1.1815085 -0.6563647  9.7391963  5.1978769        NaN
# [8]        NaN        NaN        NaN        NaN        NaN        NaN        NaN
# [15]        NaN  9.8350177        NaN        NaN        NaN  7.4056275        NaN
# [22] -0.5434995 -1.1480488 -0.5229392 -1.1554044  8.3527528        NaN  7.8801366
# [29]        NaN        NaN  3.9841614 -1.1482605  1.2581075  8.9826313        NaN
# [36]  7.7339759  7.0743497        NaN  4.4538417  5.0233545
truth$log_SR_a
# [1] -0.6911433 -0.5708845 -0.7344294 -0.6498939 -0.5526452 -0.6228628 -0.4733284
# [8] -0.4283277 -0.4707830 -0.3752548 -0.4669884 -0.3356034 -0.3941064 -0.4087566
# [15] -0.4549513 -0.5507114 -0.4055380 -0.2964126 -0.3059440 -0.5969002 -0.4635476
# [22] -0.6484311 -0.6791170 -0.6542765 -0.6913807 -0.5803369 -0.5215586 -0.5889934
# [29] -0.4111398 -0.5176146 -0.6278472 -0.6794914 -0.6442853 -0.5679687 -0.4187307
# [36] -0.5915204 -0.6018874 -0.4817429 -0.6267385 -0.6241736
truth$log_SR_b
# [1] -10.80858 -10.68832 -10.85187 -10.76733 -10.67008 -10.74030 -10.59076 -10.54576
# [9] -10.58822 -10.49269 -10.58442 -10.45304 -10.51154 -10.52619 -10.57239 -10.66815
# [17] -10.52297 -10.41385 -10.42338 -10.71434 -10.58098 -10.76587 -10.79655 -10.77171
# [25] -10.80882 -10.69777 -10.63900 -10.70643 -10.52858 -10.63505 -10.74528 -10.79693
# [33] -10.76172 -10.68541 -10.53617 -10.70896 -10.71932 -10.59918 -10.74417 -10.74161
truth$log_R_MSY
# [1] 9.743243      NaN 9.729648 9.608150      NaN      NaN      NaN      NaN
# [9]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [17]      NaN      NaN      NaN      NaN      NaN 9.559918 9.746927 9.545675
# [25] 9.743170      NaN      NaN      NaN      NaN      NaN      NaN 9.746810
# [33]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
truth$log_SSB_MSY
# [1] 11.59864      NaN 11.59901 11.17665      NaN      NaN      NaN      NaN
# [9]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [17]      NaN      NaN      NaN      NaN      NaN 11.05845 11.59846 11.03128
# [25] 11.59864      NaN      NaN      NaN      NaN      NaN      NaN 11.59846
# [33]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
truth$log_MSY
# [1] 9.946281      NaN 9.926210 9.893775      NaN      NaN      NaN      NaN      NaN
# [10]      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN      NaN
# [19]      NaN      NaN      NaN 9.854217 9.951706 9.841189 9.946173      NaN      NaN
# [28]      NaN      NaN      NaN      NaN 9.951538      NaN      NaN      NaN      NaN
# [37]      NaN      NaN      NaN      NaN



#==========================================================================
##=============   do.fit = TRUE ===========================================
#==========================================================================

###  om 49  ===============================================================

iterj=1
omi=  49      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 



y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y)

om.49a   <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, do.proj=FALSE) 
# Warning message:
#   In fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro = FALSE, do.osa = FALSE,  :
#                 
#                 ** Error during model fit. **
#                 Check for unidentifiable parameters.
#               
#               system is computationally singular: reciprocal condition number = 1.71469e-17

om.49a$rep$log_FMSY
# [1] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
# [8] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
# [15] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
# [22] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
# [29] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
# [36] -1.794201 -1.794201 -1.794201 -1.794201 -1.794201
om.49a$rep$log_R_MSY
# [1] 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568
# [9] 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568
# [17] 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568
# [25] 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568
# [33] 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568 7.778568
om.49a$rep$log_MSY
# [1] 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931
# [10] 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931
# [19] 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931
# [28] 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931 7.758931
# [37] 7.758931 7.758931 7.758931 7.758931


###  om 113  ==========================================================================

iterj=1
omi=  113      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 

y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y)




om.113a  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, do.proj=FALSE)

# Warning message:
#   In fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro = FALSE, do.osa = FALSE,  :
#                 
#                 ** Error during model fit. **
#                 Check for unidentifiable parameters.
#               
#               system is computationally singular: reciprocal condition number = 2.58876e-29

om.113a$rep$log_FMSY
# [1] -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037
# [9] -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037
# [17] -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037
# [25] -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037
# [33] -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037 -1.794037
om.113a$rep$log_R_MSY
# [1] 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202
# [10] 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202
# [19] 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202
# [28] 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202 30.4202
# [37] 30.4202 30.4202 30.4202 30.4202
om.113a$rep$log_SSB_MSY
# [1] 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381
# [9] 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381
# [17] 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381
# [25] 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381
# [33] 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381 32.10381
om.113a$rep$log_MSY
# [1] 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006
# [11] 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006
# [21] 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006
# [31] 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006 30.4006

# specify just last 2 years of Ecov for Fmsy calc
om.113b  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, do.proj=TRUE, proj.opts=list(use.FMSY=TRUE, avg.ecov.yrs=c( 2020, 2021))) #proj.opts: $use.FMSY (T/F), calculate and use FMSY for projections.
# Warning message:
#   In fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro = FALSE, do.osa = FALSE,  :
#                 
#                 ** Error during model fit. **
#                 Check for unidentifiable parameters.
#               
#               system is computationally singular: reciprocal condition number = 2.58876e-29

om.113b$rep$log_FMSY
om.113b$rep$log_R_MSY
om.113b$rep$log_SSB_MSY
om.113b$rep$log_MSY
#same as 113a... avg.ecov.yrs didn't seem to matter 


###  om 177  ==========================================================================

iterj=1
omi=  177      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 


y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )



om.177a  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, proj.opts=list(use.FMSY=TRUE))
# Warning messages:
# 1: In stats::nlminb(model$par, model$fn, model$gr, control = list(iter.max = 1000,  :
#   NA/NaN function evaluation
# 2: In stats::nlminb(model$par, model$fn, model$gr, control = list(iter.max = 1000,  :
#   NA/NaN function evaluation
# 3: In stats::nlminb(model$par, model$fn, model$gr, control = list(iter.max = 1000,  :
#   NA/NaN function evaluation
# 4: In stats::nlminb(model$par, model$fn, model$gr, control = list(iter.max = 1000,  :
#   NA/NaN function evaluation
# 5: In fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro = FALSE, do.osa = FALSE,  :
#   
# ** Error during model fit. **
# Check for unidentifiable parameters.
# 
# system is computationally singular: reciprocal condition number = 3.92844e-17

om.177a$rep$log_FMSY
# [1] -1.712114 -1.712114 -1.712114 -1.712114
# [5] -1.712114 -1.712114 -1.712114 -1.712114
# [9] -1.712114 -1.712114 -1.712114 -1.712114
# [13] -1.712114 -1.712114 -1.712114 -1.712114
# [17] -1.712114 -1.712114 -1.712114 -1.712114
# [21] -1.712114 -1.712114 -1.712114 -1.712114
# [25] -1.712114 -1.712114 -1.712114 -1.712114
# [29] -1.712114 -1.712114 -1.712114 -1.712114
# [33] -1.712114 -1.712114 -1.712114 -1.712114
# [37] -1.712114 -1.712114 -1.712114 -1.712114
om.177a$rep$log_R_MSY
# [1] 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908
# [9] 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908
# [17] 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908
# [25] 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908
# [33] 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908 10.51908
om.177a$rep$log_SSB_MSY
# [1] 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318
# [10] 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318
# [19] 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318
# [28] 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318 12.1318
# [37] 12.1318 12.1318 12.1318 12.1318
om.177a$rep$log_MSY
# [1] 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594
# [9] 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594
# [17] 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594
# [25] 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594
# [33] 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594 10.51594


om.177b  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, do.proj=TRUE, proj.opts=list(use.FMSY=TRUE, avg.ecov.yrs=c( 2020, 2021))) #proj.opts: $use.FMSY (T/F), calculate and use FMSY for projections.

# same Warning message...

om.177b$rep$log_FMSY
om.177b$rep$log_R_MSY
om.177b$rep$log_SSB_MSY
om.177b$rep$log_MSY
# same as om.177a


###  om 241  ==========================================================================

iterj=1
omi=  241      #  49 (ecov_how=0); 113 (ecov_how=1); 177 (ecov_how=2); 241 (ecov_how=4); 

y        <- data.frame(df.oms[omi,])
names(y) <- paste0('om_',names(y))
model    <- cbind(im=iterj, om=omi,  optimized=FALSE, sdreport=FALSE, y )


om.241a  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, proj.opts=list(use.FMSY=TRUE))
# Warning message:
#   In fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro = FALSE, do.osa = FALSE,  :
#                 
#                 ** Error during model fit. **
#                 Check for unidentifiable parameters.
#               
#               system is computationally singular: reciprocal condition number = 3.02474e-44

om.241a$rep$log_FMSY
# [1] -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901
# [9] -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901
# [17] -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901
# [25] -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901
# [33] -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901 -3.308901
om.241a$rep$log_R_MSY
# [1] 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498
# [9] 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498
# [17] 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498
# [25] 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498
# [33] 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498 7.305498
om.241a$rep$log_SSB_MSY
# [1] 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461
# [9] 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461
# [17] 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461
# [25] 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461
# [33] 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461 9.717461
om.241a$rep$log_MSY
# [1] 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264
# [10] 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264
# [19] 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264
# [28] 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264 6.463264
# [37] 6.463264 6.463264 6.463264 6.463264

om.241b  <- fit_wham(om_inputs[[omi]], do.fit = TRUE, do.retro=FALSE, do.osa=FALSE, do.post.samp=FALSE,
                     MakeADFun.silent = TRUE, do.proj=TRUE, proj.opts=list(use.FMSY=TRUE, avg.ecov.yrs=c( 2020, 2021))) #proj.opts: $use.FMSY (T/F), calculate and use FMSY for projections.
om.241b$rep$log_FMSY
om.241b$rep$log_R_MSY
om.241b$rep$log_SSB_MSY
om.241b$rep$log_MSY
