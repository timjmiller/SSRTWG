---
title: "Catchability_ecov_sims"
output: html_document
date: "2022-11-14"
editor_options: 
  markdown: 
    wrap: 72
---

Load packages & source functions used in simulation testing
```{r}
# Packages
library(tidyverse)
library(wham)
# Simulation testing functions
source(here::here("Ecov_study","catchability","simOM.R"))
source(here::here("Ecov_study","catchability","simTestWHAM.R"))
```



### Visual describing results structure

WHAM results objects only displayed for OM simulation 1, similar
structure for other simulations and for estimation models.

```{r}
library(DiagrammeR)
        
grViz("

digraph boxes_and_circles{
## Add node statements
# Define shape
node[shape = box]
OM[label = 'OM \n results$OM']
sim1[label = 'Simulation 1 results \n results$OM[1][[1]]']
sim2[label = 'Simulation 2 results \n results$OM[2][[1]]']
sim3[label = 'Simulation 3 results \n results$OM[3][[1]]']

EM1[label = 'EM1 \n results$EM1']
sim1_1[label = 'Simulation 1 results \n results[EMs[1]][[1]][1][[1]]']
sim1_2[label = 'Simulation 2 results \n results[EMs[1]][[1]][2][[1]]']
sim1_3[label = 'Simulation 3 results \n results[EMs[1]][[1]][2][[1]]']
EM2[label = 'EM2 \n results$EM2']
sim2_1[label = 'Simulation 1 results \n results[EMs[2]][[1]][1][[1]]']
sim2_2[label = 'Simulation 2 results \n results[EMs[2]][[1]][2][[1]]']
sim2_3[label = 'Simulation 3 results \n results[EMs[2]][[1]][3][[1]]']
ageslab[label = 'ages.lab']

# Add edge statements to connect nodes
edge[] # optional arrowhead options
# Connect nodes (may be labeled - appears on line)
results -> OM; OM -> sim1; OM -> sim2; OM -> sim3;
results -> EM1; EM1 -> sim1_1; EM1 -> sim1_2; EM1 -> sim1_3;
results -> EM2; EM2 -> sim2_1; EM2 -> sim2_2; EM2 -> sim2_3;
sim1 -> par;  
sim1 -> fn;
sim1 -> gr;
sim1 -> he;
sim1 -> hessian;
sim1 -> method;
sim1 -> retape;
sim1 -> env;
sim1 -> report;
sim1 -> simulate;
sim1 -> years;
sim1 -> years_full;
sim1 -> ageslab;
sim1 -> model_name;
sim1 -> input;
sim1 -> wham_version;
sim1 -> opt;
sim1 -> date;
sim1 -> dir;
sim1 -> rep;
sim1 -> TMB_version;
sim1 -> parList;
sim1 -> final_gradient;
sim1 -> is_sdrep;
sim1 -> na_sdrep;
sim1 -> runtime;
sim1 -> sdrep; 

# Add graph statement
graph[nodesep = 0.1, rankdir = LR] # set distance between nodes # for left-right orientation use , rankdir = LR

}   
")

```

## Post-process results

```{r}

```

# Specifics for environmentally-linked catchability WHAM runs

## Generic stock info that is never misspecified/changed
```{r}
# Pull generic groundfish life history/data
source(file.path(here::here(),"common_code", "make_basic_info.R"))
groundfish_info <- make_basic_info()

# Assume logistic selectivity for the fleet and all indices
sel_list <- list(model = c(rep("logistic", groundfish_info$n_fleets),rep("logistic", groundfish_info$n_indices)),
                   initial_pars = rep(list(c(5,1)), groundfish_info$n_fleets + groundfish_info$n_indices),
                 n_selblocks = c(groundfish_info$n_fleets + groundfish_info$n_indices)) #fleet, index

# Starting mean M estimate at 0.2, estimate constant M for all ages/years
M <- list(initial_means = rep(0.2, length(groundfish_info$ages)))

# Assume random about the mean recruitment, beverton-holt stock recruit didn't converge with an invertible hessian
recruit_model <- 2 
# NAA_list <- list(sigma="rec") # Recruitment random effects so stock recruit function implemented

genericInput <- prepare_wham_input(basic_info = groundfish_info, 
                                   selectivity = sel_list, 
                                   recruit_model = recruit_model) #,
                                   #NAA_re = NAA_list)
genericFit <- fit_wham(genericInput, MakeADFun.silent = TRUE, do.retro = FALSE, do.osa = FALSE)

```

## Define Operating Models (OMs)

All OMs should have catchability linked to an environmental covariate
but may differ in - Uncertainty around this relationship #!!!!!!!! -
Sign of this relationship (+/-) #!!!!!!!!

Set up input and fit OM1

```{r}
inputOM1 <- prepare_wham_input(model_name = "OM1") #!!!!!!!!!!!!
OM1 <- fit_wham(inputOM1, do.osa = FALSE, do.retro = FALSE, MakeADFun.silent = TRUE)
```

## Define Estimation Models (EMs)

| q-Env link                    | Seasonal misspecification |
| ----------------------------- | ------------------------- |
| Without link                  | Both seasons correct (q-Env link in EM and OM)         |
| With link                     | 1 season misspecified (q-Env linked but no link in OM) |
| Without link, q random effect | Both seasons misspecified (no link but link in OM)     |
| With link, q random effect    | |

Correctly specified link between catchability and the environment

```{r}
EMq_env <- prepare_wham_input(model_name = "EMq_env")
```

Catchability random effect and a link between catchability and the
environment

```{r}
EMq_rand_env <- prepare_wham_input(model_name = "EMq_rand_env")
```

Only a catchability random effect, fit to environmental model without
link

```{r}
EMq_rand <- prepare_wham_input(model_name ="EMq_rand")
```

No catchability considerations (i.e. status quo), fit to environmental
model without link !!!! how does this work if you feed in the ecov_beta?

```{r}
EMq <- prepare_wham_input(model_name = "EMq")
```

## Simulation testing

```{r}
simTestWHAM(nsim = 5, OM = OM1, inputEMlist = list(EMq_env, EMq_rand_env, EMq_rand, EMq)) # Update once OM/EM specifics finalized!!!!


```

## Post-process simulation results

```{r}
postprocess_simTestWHAM(filenames = c("filename1.Rds", "filename2.Rds", "ect.Rds")) # !!! Update once completed runs
```

!!!! post-process based on storage & how sims run - could run sims based
varying isim - could also loop over OM but this could be computationally
expensive - I recommend labeling runs with OM and EM names (and setting
these up with informative) so it is easy to pull out results & compare
based on model setup - pull from mod\$model_name to help aggregate data

proposed function with: - fitted OM model object - list of EM inputs

### Result formatted as list of lists, save as rdata object in specified directory with timestamp in name

run1_11_14_22.Rda\<-result - EM1 - EM2 - EM3 - EM4 - OM result

# Other things to consider

-   Other EMs can be developed (e.g. with alternative ecov process
    assumptions) but should be given DIFFERENT model_names to help with
    post-processing

# Short script for function testing purposes only!!!

```{r}
library(wham)
# For testing function
testdata <- read_asap3_dat(paste("/Users/amandahart/Research/Plaice_Methods_Development", "data", "PlaiceWHAM-2019_revised_NEFSC-LW-WAA_splitNEFSC-BigUnit_fixSeason.DAT", sep="/")) # this can be swapped out for any ASAP file you have to set up a WHAM model for debugging
testinput <- prepare_wham_input(testdata)
testWHAM <- fit_wham(testinput, MakeADFun.silent = TRUE, do.osa = FALSE, do.retro=FALSE)

OM <- testWHAM
testinput1 <- prepare_wham_input(testdata, model_name = "test1")
testinput2 <- prepare_wham_input(testdata, model_name="test2")
testinput3 <- prepare_wham_input(testdata, model_name="test3")
inputEMlist <- list(testinput1, testinput2, testinput3)

test <- simTestWHAM(nsim = 2, OM = OM, inputEMlist = inputEMlist)
```

# To do next

- Finish OM setup
  - change how ecov passed in
  - set up range of uncertainty values to explore
  - tim sets equilibrium F (eq_F_init)
    - setup OM without fit & use model to find F40 proxy
  - Tim also sets intitial numbers at age based on equilibrium (overfished F=eqFN1*max_mult_Fmsy or not eqFN1=0)
- Tim lines 71-79 pf make_om use internal processing for prepare_wham_input to plug in setup from M_Ecov_om_setup.R
- Update what is saved as output
  - calculate performance metrics
- Run simulations, hpcc?
- Separate sims and function scripts





